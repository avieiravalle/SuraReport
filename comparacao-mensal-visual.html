<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparação Mensal Visual - Qualidade</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="dadosPreenchimento.js"></script>
    <script src="utils.js"></script>
    <style>
        :root {
            --primary-color: #0033A0;
            --secondary-color: #00A79D;
            --tertiary-color: #e74c3c;
            --positive-color: #2ecc71;
            --negative-color: #e74c3c;
            --neutral-color: #f39c12;
            --header-color: #0033A0;
            --body-background: #f4f6f9;
            --text-color: #58595B;
            --card-background: white;
            --border-color: #e0e0e0;
            --container-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.07);
            --card-border-radius: 8px;
            --font-family-base: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family-base); }
        body { background-color: var(--body-background); color: var(--text-color); line-height: 1.6; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background-color: var(--card-background); border-radius: 12px; box-shadow: var(--container-shadow); padding: 25px; }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        header #company-logo { max-height: 45px; margin-bottom: 15px; }
        header h1 { color: var(--header-color); margin-bottom: 10px; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; padding: 15px; background-color: #fdfdfd; border-radius: var(--card-border-radius); border: 1px solid var(--border-color); }
        .control-group { display: flex; align-items: center; gap: 15px; }
        select, button { padding: 8px 13px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--card-background); font-size: 12px; }
        button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        button:hover { background-color: #00227A; transform: translateY(-1px); }
        #return-btn { background-color: #6c757d; }
        #return-btn:hover { background-color: #5a6268; }

        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background-color: var(--card-background); padding: 20px; border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); text-align: center; border-left: 5px solid var(--primary-color); }
        .summary-card:nth-child(2) { border-left-color: var(--secondary-color); }
        .summary-card:nth-child(3) { border-left-color: var(--neutral-color); }
        .summary-card:nth-child(4) { border-left-color: var(--tertiary-color); }
        .summary-card h3 { color: var(--header-color); font-size: 1.0em; margin-bottom: 10px; }
        .summary-card p { font-size: 2.3em; font-weight: 700; color: var(--primary-color); }
        .summary-card small { font-size: 0.8em; color: #777; }

        .highlight-section { text-align: center; padding: 25px; margin-bottom: 30px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: var(--card-border-radius); }
        .highlight-section h2 { color: var(--header-color); font-size: 1.1em; }
        .highlight-section p { font-size: 2.8em; font-weight: 700; margin: 5px 0; }
        .highlight-section .highlight-trend { font-size: 1.1em; font-weight: 600; }
        .highlight-section small { display: block; margin-top: 5px; color: #666; }

        .main-chart-container { height: 450px; margin-bottom: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); }
        
        .charts-section, .trend-analysis-section { background-color: var(--card-background); border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); padding: 20px; border: 1px solid var(--border-color); margin-bottom: 30px; }
        .section-header { color: var(--header-color); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); font-size: 1.4em; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .chart-container { height: 380px; padding: 15px; border: 1px solid var(--border-color); border-radius: var(--card-border-radius); }
        .chart-container h3 { text-align: center; margin-bottom: 15px; color: var(--primary-color); font-weight: 600; }

        .trend-table { width: 100%; border-collapse: collapse; }
        .trend-table th, .trend-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .trend-table thead th { background-color: #f2f5f8; font-weight: 600; color: var(--primary-color); }
        .trend-table thead th[data-sort] { cursor: pointer; user-select: none; }
        .trend-table thead th[data-sort]:hover { background-color: #e2e6ea; }
        .trend-table tbody tr:nth-child(even) { background-color: #fbfcfe; }
        .trend-table tbody tr:hover { background-color: #f0f4f8; }

        .trend-positive { color: var(--positive-color); font-weight: 600; }
        .trend-negative { color: var(--negative-color); font-weight: 600; }
        .trend-neutral { color: var(--text-color); }

        .metric-badge { padding: 4px 10px; border-radius: 12px; color: white; font-size: 0.75em; font-weight: 600; }
        .badge-positive { background-color: var(--positive-color); }
        .badge-negative { background-color: var(--negative-color); }
        .badge-neutral { background-color: var(--neutral-color); }

        .main-chart-container {
            background-color: var(--card-background); padding: 20px; border-radius: var(--card-border-radius);
            box-shadow: var(--card-shadow); border: 1px solid var(--border-color);
            height: 350px;
            margin-bottom: 30px;
        }

        @media print {
            body {
                padding: 0;
                margin: 0;
                background-color: white;
                font-size: 8px; /* Fonte ainda mais reduzida para garantir 1 página */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            header, .controls, #return-btn, #save-pdf-btn {
                display: none !important;
            }

            .container {
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 10px;
                box-shadow: none !important;
                border: none !important;
            }

            .summary-cards {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }

            .summary-card {
                padding: 8px;
                border: 1px solid #ddd;
                box-shadow: none !important;
            }
            .summary-card h3 { font-size: 10px; margin-bottom: 5px; }
            .summary-card p { font-size: 16px; margin: 0; }

            .main-chart-container {
                height: 160px !important; /* Altura reduzida */
                margin-bottom: 15px;
                padding: 5px;
                border: 1px solid #ddd;
                box-shadow: none !important;
                page-break-inside: avoid;
            }

            .charts-section {
                padding: 0;
                margin-bottom: 15px;
                box-shadow: none !important;
                border: none;
            }

            .charts-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .chart-container {
                height: 140px !important; /* Altura reduzida */
                padding: 5px;
                border: 1px solid #ddd;
                box-shadow: none !important;
                page-break-inside: avoid;
            }

            .trend-analysis-section {
                padding: 0;
                box-shadow: none !important;
                border: none;
                page-break-inside: avoid;
            }

            .trend-table {
                width: 100% !important;
                font-size: 8px;
            }
            .trend-table th, .trend-table td {
                padding: 4px;
                border: 1px solid #eee;
            }
        }

        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-container { height: 350px; }
        }
    </style>
</head>
<body>
    <div class="container" id="comparison-container">
        <header>
            <img src="logo.png" alt="Logo Sura Seguros" id="company-logo">
            <h1>Análise de Tendências - Qualidade</h1>
        </header>

        <div class="controls">
            <div class="control-group">
                <label for="product-select">Produto:</label>
                <select id="product-select">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="control-group">
                <label for="period-select">Período:</label>
                <select id="period-select">
                    <option value="6">Últimos 6 meses</option>
                    <option value="12" selected>Últimos 12 meses</option>
                    <option value="all">Todo o histórico</option>
                </select>
            </div>
            <div class="control-group">
                <button id="save-pdf-btn">Salvar como PDF</button>
                <button id="return-btn">Voltar ao Relatório</button>
            </div>
        </div>

        <div class="main-chart-container">
            <canvas id="overall-health-chart"></canvas>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <h3>Pass Rate (Mês)</h3>
                <p id="pass-rate-value">--%</p>
                <small>Média das sprints</small>
            </div>
            <div class="summary-card">
                <h3>Cobertura de Testes</h3>
                <p id="test-coverage-value">--%</p>
                <small>Média das sprints</small>
            </div>
            <div class="summary-card">
                <h3>Total de Bugs (Mês)</h3>
                <p id="bugs-value">--</p>
                <small>Soma: Produtivos & Não Produtivos</small>
            </div>
            <div class="summary-card">
                <h3>Cobertura de Código</h3>
                <p id="coverage-value">--%</p>
                <small>Média geral do mês</small>
            </div>
        </div>

        <div class="trend-analysis-section" id="trend-analysis-section">
            <h2 class="section-header">Análise de Tendências Detalhada</h2>
            <table class="trend-table">
                <thead>
                    <tr>
                        <th data-sort="name">Métrica</th>
                        <th data-sort="prev">Mês Anterior</th>
                        <th data-sort="curr">Mês Atual</th>
                        <th data-sort="change">Variação</th>
                        <th data-sort="status">Status vs Meta</th>
                    </tr>
                </thead>
                <tbody id="trend-table-body">
                    <!-- Rows will be populated by JS -->
                </tbody>
            </table>
        </div>

        <div class="charts-section">
            <h2 class="section-header">Evolução das Métricas</h2>
            <div class="charts-grid">
                <div class="chart-container">
                    <canvas id="code-coverage-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="bugs-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="bugs-severity-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="rework-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="leadtime-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="automated-tests-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="test-cases-per-us-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="qa-efficiency-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção oculta para a metodologia do PDF -->
    <div id="pdf-methodology-section" style="display: none; padding: 20px; font-family: 'Segoe UI', sans-serif; color: #333; background-color: white;">
        <h2 style="color: #0033A0; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; font-size: 24px;">Metodologia de Cálculo</h2>
        <div style="font-size: 16px; line-height: 1.6;">
            <h4 style="color: #0033A0; margin-top: 20px; margin-bottom: 5px;">Cobertura de Testes (Funcional)</h4>
            <p>Mede o quão bem as User Stories (US) estão cobertas por Casos de Teste (CTs). A meta é ter 3 CTs por US para garantir uma cobertura adequada.</p>
            <p><strong>Fórmula:</strong> <code>(Total de CTs / (Total de US * 3)) * 100%</code></p>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">


            <h4 style="color: #0033A0; margin-top: 20px; margin-bottom: 5px;">Economia de Tempo (Automação)</h4>
            <p>Mede o tempo economizado (em minutos) ao executar testes de forma automatizada em vez de manual.</p>
            <p><strong>Fórmula:</strong> <code>Tempo de Execução Manual - Tempo de Execução Automatizado</code></p>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

            <h4 style="color: #0033A0; margin-top: 20px; margin-bottom: 5px;">Índice de Qualidade (Visão de Tendências)</h4>
            <p>Um score de 0 a 10 que consolida várias métricas (Cobertura de Código, Pass Rate, Bugs, etc.) em um único indicador para facilitar a comparação da saúde geral do produto ao longo do tempo.</p>
        </div>
    </div>

    <script src="comparacao-mensal-visual.js"></script>
</body>
</html>